@page "/logina"

@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Authorization

@inject NavigationManager Navigation
@inject HttpClient Http

<PageTitle>Login</PageTitle>

<h1>Login</h1>

<AuthorizeView Context="authContext">
    <Authorized>
        <div class="alert alert-success">
            You're logged in as @authContext.User.Identity?.Name.
        </div>
    </Authorized>

    <NotAuthorized>
        <div class="row">
            <div class="col">
                <section>
                    <div class="d-flex justify-content-center align-items-center min-vh-90 bg-light">
                        <div class="card shadow-sm" style="width: 420px;">
                            <div class="card-body p-4">
                                <h3 class="text-center mb-4">Login</h3>

                                <form method="post" action="/auth/login">
                                    <input type="hidden" name="returnUrl" value="@ReturnUrl" />

                                    <div class="mb-3">
                                        <label class="form-label">Username</label>
                                        <input class="form-control form-control-lg"
                                               name="username"
                                               autocomplete="username"
                                               placeholder="Enter username" />
                                    </div>

                                    <div class="mb-4">
                                        <label class="form-label">Password</label>
                                        <input class="form-control form-control-lg"
                                               type="password"
                                               name="password"
                                               autocomplete="current-password"
                                               placeholder="Enter password" />
                                    </div>

                                    <button type="submit"
                                            class="btn btn-primary btn-lg w-100">
                                        Log in
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>


                </section>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {

    private string ReturnUrl = "/";
    private InputModel Input { get; set; } = new();

    //[SupplyParameterFromQuery]
    //private string? ReturnUrl { get; set; }

    protected override void OnInitialized()
    {
        var uri = new Uri(Navigation.Uri);

        if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query)
            .TryGetValue("ReturnUrl", out var returnUrl))
        {
            ReturnUrl = returnUrl!;
        }
    }

    private async Task LoginUserAsync()
    {
        var response = await Http.PostAsync(
            $"{Navigation.BaseUri}auth/login",
            new FormUrlEncodedContent(new Dictionary<string, string>
            {
                ["username"] = Input.username,
                ["password"] = Input.password,
                ["returnUrl"] = ReturnUrl ?? "/"
            }));

        if (response.IsSuccessStatusCode)
        {
            Navigation.NavigateTo(ReturnUrl ?? "/", forceLoad: true);
        }
    }




    private sealed class InputModel
    {
        // [Required]
        // [EmailAddress]
        public string username { get; set; } = string.Empty;

        // [Required]
        // [DataType(DataType.Password)]
        public string password { get; set; } = string.Empty;
    }
}
